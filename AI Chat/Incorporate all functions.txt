Was done in scope of other commits (was needed for end-2-end testing)

But decided to clean up the code a bit and make it easier to test.